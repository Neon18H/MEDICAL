{% extends "base.html" %}
{% block content %}
<div class="row g-3">
  <div class="col-xl-3">
    <div class="card shadow-sm border-0 mb-3">
      <div class="card-body">
        <h5 class="fw-bold" id="procedureTitle">Procedimiento</h5>
        <p class="text-muted small" id="procedureMeta">Especialidad · Dificultad</p>
        <div class="step-panel" id="stepsList"></div>
        <div class="mt-3">
          <div class="small text-uppercase text-muted">Objetivo</div>
          <div id="stepObjective" class="fw-semibold"></div>
          <div class="small text-uppercase text-muted mt-2">Instrumento recomendado</div>
          <div id="stepInstrument" class="fw-semibold"></div>
          <div class="small text-uppercase text-muted mt-2">Riesgos</div>
          <ul id="stepRisks" class="small"></ul>
          <div class="small text-uppercase text-muted mt-2">Tips</div>
          <ul id="stepTips" class="small"></ul>
        </div>
      </div>
    </div>
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <h6 class="fw-bold">Instrumentos</h6>
        <div id="instrumentList" class="d-grid gap-2"></div>
        <div class="mt-3">
          <label class="form-label small">Intensidad</label>
          <input type="range" id="intensitySlider" min="1" max="10" value="5" class="form-range" />
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-6">
    <div class="card shadow-sm border-0 mb-3">
      <div class="card-body">
        <div class="simulator-hud">
          <div>
            <div class="hud-label">Paso actual</div>
            <div class="hud-value" id="currentStepLabel">-</div>
          </div>
          <div>
            <div class="hud-label">Cronómetro</div>
            <div class="hud-value" id="timer">00:00</div>
          </div>
          <div>
            <div class="hud-label">Errores</div>
            <div class="hud-value" id="errorCount">0</div>
          </div>
          <div>
            <div class="hud-label">Zona</div>
            <div class="hud-value" id="zoneStatus">Estable</div>
          </div>
          <div>
            <div class="hud-label">Progreso</div>
            <div class="hud-value" id="progressLabel">0%</div>
          </div>
        </div>
        <div id="threeContainer" class="three-canvas"></div>
        <div class="mt-3 d-flex flex-wrap gap-2">
          <button class="btn btn-outline-primary action-btn" data-action="CUT">Corte</button>
          <button class="btn btn-outline-primary action-btn" data-action="SUTURE">Sutura</button>
          <button class="btn btn-outline-primary action-btn" data-action="GRAB">Pinzar</button>
          <button class="btn btn-outline-primary action-btn" data-action="COAGULATE">Cauterizar</button>
          <button class="btn btn-outline-primary action-btn" data-action="IRRIGATE">Irrigar</button>
          <button id="resetView" class="btn btn-outline-secondary">Reset view</button>
          <button id="finishAttempt" class="btn btn-success ms-auto">Finalizar simulación</button>
        </div>
        <div class="mt-3">
          <div class="small text-uppercase text-muted">Eventos en vivo</div>
          <div id="liveAlerts" class="small"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-3">
    <div class="card shadow-sm border-0 mb-3">
      <div class="card-body">
        <h6 class="fw-bold">Guía Quirúrgica</h6>
        <div class="ai-coach">
          <div class="ai-section">
            <div class="small text-uppercase text-muted">Paso recomendado ahora</div>
            <div id="aiNextStep" class="fw-semibold"></div>
          </div>
          <div class="ai-section">
            <div class="small text-uppercase text-muted">Checklist del paso</div>
            <ul id="aiChecklist" class="small"></ul>
          </div>
          <div class="ai-section">
            <div class="small text-uppercase text-muted">Cuidado con…</div>
            <ul id="aiWarnings" class="small"></ul>
          </div>
          <div class="ai-chat mt-3">
            <label class="form-label small">Pregúntale al tutor IA</label>
            <textarea id="aiQuestion" class="form-control form-control-sm" rows="2" placeholder="¿Cuál es el siguiente paso?"></textarea>
            <button id="aiAskBtn" class="btn btn-primary btn-sm w-100 mt-2">Enviar pregunta</button>
            <div id="aiAnswer" class="small mt-2 text-muted"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <h6 class="fw-bold">Checklist general</h6>
        <div id="checklist" class="small"></div>
        <div class="mt-3">
          <strong>Errores</strong>
          <ul id="errors" class="small"></ul>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/three@0.162.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.162.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.162.0/examples/js/loaders/GLTFLoader.js"></script>
<script>
  window.App.startSimulator({{ procedure_id }});
</script>
{% endblock %}
